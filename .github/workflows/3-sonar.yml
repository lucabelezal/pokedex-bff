name: "3 - SonarQube Analysis"

on:
  # Workflow dispatch manual para anÃ¡lises especÃ­ficas
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to analyze'
        required: false
        default: 'main'
        type: string
      
  # AnÃ¡lise automÃ¡tica semanal na main
  schedule:
    - cron: '0 2 * * 1' # Segunda-feira Ã s 2h UTC
    
  # AnÃ¡lise para PRs crÃ­ticos (opcional - pode ser removido se jÃ¡ estÃ¡ no 1-feature.yml)
  pull_request:
    types: [opened]
    branches: [main]
    paths:
      - 'src/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'

jobs:
  # AnÃ¡lise dedicada do SonarQube
  sonar-analysis:
    name: ğŸ” SonarQube Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'sonar-required'))
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch || github.ref }}

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ”§ Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: ğŸ“¦ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: ğŸ” Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./gradlew build jacocoTestReport sonar --parallel --daemon --no-scan \
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY || 'pokedex-bff' }} \
            -Dsonar.organization=${{ vars.SONAR_ORGANIZATION || 'lucabelezal' }} \
            -Dsonar.branch.name=${{ inputs.branch || github.ref_name }}

      - name: ğŸ“Š SonarQube Quality Gate check
        uses: sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      - name: ğŸ“‹ Analysis Summary
        run: |
          echo "ğŸ” SonarQube Analysis completed for branch: ${{ inputs.branch || github.ref_name }}"
          echo "ğŸ“Š View results at: https://sonarcloud.io/project/overview?id=${{ vars.SONAR_PROJECT_KEY || 'pokedex-bff' }}"