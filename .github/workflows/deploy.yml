name: "Deploy"

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: string
      bump:
        description: "Auto bump type if version is empty"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: "Optional SemVer (e.g. 1.2.3). If empty, auto-bump from latest vX.Y.Z"
        required: false
        default: ""
        type: string

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Set up Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: ğŸ·ï¸ Compute release version
        id: rel
        env:
          INPUT_VERSION: ${{ inputs.version }}
          BUMP: ${{ inputs.bump }}
        run: |
          set -euo pipefail

          semver_re='^[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'

          if [ -n "$INPUT_VERSION" ]; then
            if ! echo "$INPUT_VERSION" | grep -Eq "$semver_re"; then
              echo "âŒ Invalid SemVer: $INPUT_VERSION" >&2
              exit 1
            fi
            version="$INPUT_VERSION"
          else
            latest_tag=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1)
            if [ -z "$latest_tag" ]; then
              base="0.0.0"
            else
              base="${latest_tag#v}"
            fi

            IFS='.' read -r major minor patch <<<"$base"
            case "$BUMP" in
              major) major=$((major+1)); minor=0; patch=0;;
              minor) minor=$((minor+1)); patch=0;;
              patch|"") patch=$((patch+1));;
              *) echo "âŒ Unknown bump type: $BUMP" >&2; exit 1;;
            esac
            version="$major.$minor.$patch"
          fi

          tag="v$version"

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: ğŸ·ï¸ Create and push tag
        env:
          TAG: ${{ steps.rel.outputs.tag }}
        run: |
          set -euo pipefail
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âŒ Tag already exists: $TAG" >&2
            exit 1
          fi

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: ğŸ§ª Smoke build (no tests)
        run: ./gradlew build -x test --parallel --daemon --no-scan

      - name: ğŸš€ Deploy
        env:
          VERSION: ${{ steps.rel.outputs.version }}
          DEPLOY_ENV: ${{ inputs.environment }}
        run: |
          echo "ğŸš€ Deploying to $DEPLOY_ENV environment..."
          echo "ğŸ·ï¸ Version: v$VERSION"
          echo "ğŸ“¦ Artifact: $(ls build/libs/*.jar | head -1)"
          # Adicionar aqui os passos especÃ­ficos de deploy
          echo "âœ… Deployment completed successfully!"
