name: "Main CI/CD"

permissions:
  contents: write
  actions: read

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      run_deployment:
        description: 'Run deployment steps'
        required: false
        default: true
        type: boolean
      run_sonar:
        description: 'Run SonarQube analysis'
        required: false
        default: true
        type: boolean
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: string

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Set up Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: ğŸ§¹ Run lint (ktlint/detekt)
        run: ./gradlew ktlintCheck detekt --parallel --daemon --no-scan

      - name: ğŸ§ª Run tests with coverage
        run: ./gradlew test jacocoTestReport --parallel --daemon --no-scan

      - name: ğŸ“Š Upload coverage to Codecov
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        if: env.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/reports/jacoco/test/jacocoTestReport.xml
          fail_ci_if_error: false

      - name: ğŸ“¦ Upload coverage artifact (Jacoco XML)
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/test/jacocoTestReport.xml
          if-no-files-found: error

      - name: ğŸ—ï¸ Build application
        run: ./gradlew build -x test --parallel --daemon --no-scan

      - name: ğŸ“ Show application size
        run: |
          ls -lh build/libs/
          echo "ğŸ“¦ Application size: $(du -sh build/libs/*.jar | head -1 | awk '{print $1}')"

      - name: ğŸ“¦ Upload build artifact (JAR)
        if: github.event_name == 'push' || inputs.run_deployment
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar
          if-no-files-found: error

  sonar-analysis:
    needs: build-and-test
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.run_sonar)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Set up Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“¥ Download coverage artifact (Jacoco XML)
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/test

      - name: ğŸ” Check Sonar token
        id: sonar_token
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -n "$SONAR_TOKEN" ]; then
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_token=false" >> "$GITHUB_OUTPUT"
            echo "SONAR_TOKEN not set; skipping Sonar analysis."
          fi

      - name: ğŸ”§ Cache SonarQube packages
        if: steps.sonar_token.outputs.has_token == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: ğŸ” SonarQube analysis
        if: steps.sonar_token.outputs.has_token == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: |
          ./gradlew sonar -x test --parallel --daemon --no-scan \
            -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
            -Dsonar.organization="$SONAR_ORGANIZATION" \
            -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml

  deploy:
    needs: [build-and-test, sonar-analysis]
    if: always() && (github.event_name == 'push' || inputs.run_deployment) && needs.build-and-test.result == 'success' && (needs.sonar-analysis.result == 'success' || needs.sonar-analysis.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download build artifact (JAR)
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: build/libs

      - name: ğŸ·ï¸ Create release tag
        if: github.ref == 'refs/heads/main'
        run: |
          VERSION=$(date +'%Y.%m.%d')-${GITHUB_SHA::7}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"

      - name: ğŸš€ Deploy
        run: |
          DEPLOY_ENV='${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}'
          echo "ğŸš€ Deploying to $DEPLOY_ENV environment..."
          echo "ğŸ“¦ Artifact: $(ls build/libs/*.jar | head -1)"
          echo "ğŸ·ï¸ Version: ${VERSION:-development}"
          # Adicionar aqui os passos especÃ­ficos de deploy
          echo "âœ… Deployment completed successfully!"