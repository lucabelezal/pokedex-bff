name: "1 - Feature CI"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - '.gitignore'
      - 'LICENSE'

jobs:
  # Verifica se a branch segue conventional commits
  validate-branch:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: ðŸ” Check branch naming convention
        id: check
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Conventional commit types seguindo o padrÃ£o
          if [[ $BRANCH_NAME =~ ^(feat|feature|fix|hotfix|docs|style|refactor|perf|test|ci|build|chore|revert)/.+ ]]; then
          # Also allow 'pr/' prefix used for PR branch created by helper
          if [[ $BRANCH_NAME =~ ^(pr)/.+ ]]; then
            echo "âœ… Branch follows conventional naming (pr/)"
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Branch follows conventional naming"
            echo "should-run=true" >> $GITHUB_OUTPUT
          fi
          else
            echo "âŒ Branch does not follow conventional naming"
            echo "Expected format: type/description (e.g., feat/add-pokemon-search, fix/bug-authentication)"
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi

  # Job principal que usa o workflow compartilhado
  ci:
    needs: validate-branch
    if: needs.validate-branch.outputs.should-run == 'true'
    uses: ./.github/workflows/shared-ci.yml
    with:
      run-sonar: false
      run-codecov: true
      run-deployment: false
      environment: 'development'
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
