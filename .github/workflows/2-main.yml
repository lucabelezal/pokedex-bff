name: "2 - Main CI/CD"

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - '.gitignore'
      - 'LICENSE'

jobs:
  # Job principal que usa o workflow compartilhado
  cicd:
    uses: ./.github/workflows/shared-ci.yml
    with:
      run-sonar: true
      run-codecov: true
      run-deployment: true
      environment: 'production'
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # Notifica√ß√£o de deploy (opcional)
  notify:
    needs: cicd
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: üì¢ Deployment notification
        run: |
          if [ "${{ needs.cicd.result }}" == "success" ]; then
            echo "‚úÖ Deployment to production completed successfully!"
            echo "üì¶ Application deployed at: $(date)"
          else
            echo "‚ùå Deployment failed!"
            echo "üîç Check the logs for more details"
          fi